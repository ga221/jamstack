#ifndef SYNTH_TONEWHEEL_H_
#define SYNTH_TONEWHEEL_H_

#include "SoundStream.h"

#if defined(__ARM_ARCH_7EM__)
#include "arm_math.h"
#else
#include <math.h>
#endif

class SoundSynthHammond : public SoundStream
{
public:
  SoundSynthHammond() : SoundStream(0, NULL), magnitude1(16384) {}

  void tonewheel(int incr1, int incr2, int incr3, int incr4, int incr5, int incr6, int incr7, int incr8, int incr9)
  {
    phase_increment1 = Tonewheel[incr1];
    phase_increment2 = Tonewheel[incr2];
    phase_increment3 = Tonewheel[incr3];
    phase_increment4 = Tonewheel[incr4];
    phase_increment5 = Tonewheel[incr5];
    phase_increment6 = Tonewheel[incr6];
    phase_increment7 = Tonewheel[incr7];
    phase_increment8 = Tonewheel[incr8];
    phase_increment9 = Tonewheel[incr9];
  }

  void phase(float angle)
  {
    noteOn = 1;
    if(angle > 360.0)
    {
      noteOn = 0;
    }
    phase_accumulator1 = angle * (4294967296.0 / 360.0);
    phase_accumulator2 = phase_accumulator1;
    phase_accumulator3 = phase_accumulator1;
    phase_accumulator4 = phase_accumulator1;
    phase_accumulator5 = phase_accumulator1;
    phase_accumulator6 = phase_accumulator1;
    phase_accumulator7 = phase_accumulator1;
    phase_accumulator8 = phase_accumulator1;
    phase_accumulator9 = phase_accumulator1;
  }
  void
  drawbars(uint8_t n1, uint8_t n2, uint8_t n3, uint8_t n4, uint8_t n5, uint8_t n6, uint8_t n7, uint8_t n8, uint8_t n9)
  {
    magnitude1 = n1 << 8;
    magnitude2 = n2 << 8;
    magnitude3 = n3 << 8;
    magnitude4 = n4 << 8;
    magnitude5 = n5 << 8;
    magnitude6 = n6 << 8;
    magnitude7 = n7 << 8;
    magnitude8 = n8 << 8;
    magnitude9 = n9 << 8;
  }

  void percussive(uint8_t value) { percussiveVoice = value; }

  void initRAM(uint8_t bank)
  {
    switch(bank)
    {
      case 1:
        for(uint16_t i = 0; i < 257; i++)
        {
          toneGenRAM[i] = toneGenWave1[i];
        }
        break;
      case 2:
        for(uint16_t i = 0; i < 257; i++)
        {
          toneGenRAM[i] = toneGenWave2[i];
        }
        break;
      case 3:
        for(uint16_t i = 0; i < 257; i++)
        {
          toneGenRAM[i] = toneGenWave3[i];
        }
        break;
      case 4:
        for(uint16_t i = 0; i < 257; i++)
        {
          toneGenRAM[i] = toneGenWave4[i];
        }
        break;
    }
  }

  virtual void update(void) override;

private:
  const int32_t Tonewheel[92]
      = {0,         3182650,   3371709,   3574008,   3785944,   4010926,   4248077,   4502557,   4770276,   5051820,
         5354392,   5671859,   6008017,   6365399,   6743418,   7148114,   7571889,   8021853,   8496252,   9005114,
         9540553,   10103640,  10708784,  11343718,  11998609,  12730700,  13486935,  14296130,  15143779,  16043706,
         16992406,  18010228,  19081106,  20207280,  21417568,  22687338,  24032166,  25461400,  26973772,  28592358,
         30287460,  32087412,  33984912,  36020456,  38162212,  40414468,  42835136,  45374776,  48064332,  50922900,
         53947544,  57184616,  60574920,  64174824,  67969824,  72040912,  76324424,  80828936,  85670272,  90749552,
         96128768,  101845800, 107895184, 114369336, 121149840, 128349648, 135939648, 144081824, 152648848, 155816800,
         171340544, 181499104, 192257440, 203691600, 215790272, 228738576, 242299776, 256699296, 271879200, 288163648,
         305297696, 323315840, 342681088, 362998208, 384514880, 407818816, 432245472, 457946560, 484973792, 514021664,
         544497216, 576772288};

  const int toneGenWave1[257]
      = {0,      1223,   2446,   3665,   4877,   6083,   7279,   8463,   9633,   10789,  11927,  13048,  14149,  15227,
         16283,  17313,  18317,  19293,  20242,  21159,  22046,  22900,  23721,  24507,  25260,  25977,  26656,  27300,
         27906,  28475,  29006,  29498,  29953,  30369,  30747,  31088,  31390,  31655,  31884,  32075,  32230,  32350,
         32435,  32486,  32503,  32488,  32441,  32364,  32256,  32120,  31956,  31766,  31549,  31308,  31042,  30756,
         30447,  30120,  29773,  29408,  29026,  28630,  28219,  27795,  27358,  26912,  26454,  25988,  25514,  25033,
         24546,  24053,  23557,  23056,  22553,  22050,  21545,  21039,  20532,  20027,  19523,  19020,  18521,  18025,
         17530,  17040,  16554,  16072,  15593,  15120,  14651,  14187,  13729,  13275,  12826,  12383,  11945,  11512,
         11084,  10662,  10244,  9831,   9424,   9021,   8622,   8229,   7840,   7454,   7073,   6695,   6321,   5952,
         5584,   5220,   4859,   4500,   4145,   3791,   3440,   3090,   2742,   2396,   2051,   1707,   1364,   1022,
         680,    340,    0,      -340,   -680,   -1022,  -1364,  -1707,  -2051,  -2395,  -2742,  -3090,  -3439,  -3791,
         -4144,  -4500,  -4859,  -5220,  -5584,  -5951,  -6322,  -6695,  -7073,  -7454,  -7840,  -8229,  -8622,  -9021,
         -9424,  -9832,  -10244, -10662, -11084, -11512, -11945, -12383, -12826, -13275, -13728, -14187, -14651, -15120,
         -15593, -16072, -16553, -17040, -17530, -18025, -18520, -19020, -19523, -20027, -20532, -21038, -21543, -22049,
         -22553, -23056, -23557, -24053, -24546, -25033, -25514, -25988, -26453, -26912, -27358, -27795, -28219, -28630,
         -29026, -29407, -29773, -30120, -30447, -30755, -31043, -31307, -31549, -31766, -31956, -32120, -32256, -32364,
         -32441, -32488, -32503, -32486, -32435, -32350, -32230, -32075, -31883, -31655, -31391, -31088, -30747, -30369,
         -29953, -29498, -29006, -28475, -27906, -27300, -26656, -25977, -25260, -24507, -23721, -22900, -22046, -21159,
         -20242, -19294, -18317, -17313, -16283, -15227, -14149, -13048, -11929, -10789, -9633,  -8463,  -7279,  -6083,
         -4877,  -3665,  -2446,  -1224,  0};

  const int toneGenWave2[257]
      = {0,      1474,   2916,   4296,   5588,   6769,   7821,   8735,   9507,   10143,  10651,  11048,  11356,  11595,
         11797,  11984,  12184,  12420,  12713,  13077,  13523,  14056,  14676,  15378,  16152,  16987,  17864,  18770,
         19687,  20599,  21490,  22350,  23170,  23942,  24663,  25334,  25956,  26535,  27074,  27580,  28058,  28513,
         28949,  29365,  29764,  30144,  30501,  30831,  31129,  31390,  31610,  31786,  31914,  31996,  32032,  32028,
         31990,  31925,  31841,  31749,  31658,  31576,  31511,  31471,  31456,  31471,  31511,  31576,  31658,  31749,
         31841,  31925,  31990,  32028,  32032,  31996,  31914,  31785,  31610,  31390,  31129,  30831,  30501,  30144,
         29764,  29366,  28949,  28513,  28058,  27580,  27074,  26535,  25957,  25334,  24663,  23942,  23169,  22350,
         21490,  20599,  19687,  18770,  17864,  16986,  16152,  15378,  14676,  14056,  13523,  13077,  12713,  12421,
         12184,  11984,  11797,  11595,  11356,  11048,  10652,  10143,  9507,   8735,   7821,   6769,   5588,   4296,
         2916,   1474,   0,      -1474,  -2916,  -4296,  -5588,  -6769,  -7820,  -8734,  -9507,  -10143, -10651, -11048,
         -11355, -11595, -11797, -11983, -12184, -12420, -12713, -13077, -13523, -14056, -14676, -15378, -16152, -16986,
         -17864, -18770, -19687, -20599, -21490, -22350, -23169, -23942, -24663, -25334, -25956, -26535, -27074, -27580,
         -28058, -28513, -28948, -29365, -29764, -30144, -30501, -30831, -31129, -31390, -31610, -31785, -31913, -31995,
         -32032, -32028, -31990, -31925, -31841, -31749, -31658, -31576, -31511, -31471, -31456, -31471, -31511, -31576,
         -31658, -31749, -31841, -31925, -31990, -32028, -32033, -31996, -31914, -31785, -31610, -31390, -31129, -30831,
         -30501, -30144, -29764, -29366, -28949, -28513, -28058, -27580, -27074, -26535, -25957, -25334, -24663, -23942,
         -23170, -22350, -21490, -20599, -19687, -18771, -17864, -16987, -16153, -15378, -14676, -14056, -13523, -13076,
         -12713, -12421, -12184, -11984, -11796, -11595, -11355, -11048, -10652, -10143, -9507,  -8735,  -7821,  -6769,
         -5588,  -4297,  -2917,  -1474,  0};

  const int toneGenWave3[257]
      = {0,      2303,   4533,   6622,   8507,   10139,  11479,  12507,  13217,  13621,  13745,  13628,  13322,  12883,
         12376,  11862,  11401,  11049,  10850,  10837,  11033,  11446,  12073,  12896,  13891,  15027,  16261,  17555,
         18869,  20163,  21404,  22567,  23633,  24590,  25435,  26174,  26815,  27374,  27868,  28315,  28732,  29134,
         29531,  29928,  30328,  30726,  31113,  31478,  31808,  32088,  32304,  32447,  32509,  32486,  32380,  32201,
         31961,  31675,  31366,  31053,  30759,  30506,  30311,  30188,  30145,  30188,  30311,  30506,  30759,  31053,
         31366,  31675,  31961,  32201,  32380,  32486,  32509,  32447,  32304,  32088,  31808,  31478,  31113,  30726,
         30328,  29929,  29531,  29134,  28732,  28315,  27868,  27374,  26816,  26174,  25435,  24590,  23633,  22567,
         21404,  20163,  18869,  17555,  16261,  15027,  13892,  12896,  12073,  11446,  11033,  10837,  10850,  11049,
         11401,  11862,  12375,  12883,  13322,  13628,  13746,  13621,  13217,  12507,  11480,  10139,  8507,   6622,
         4533,   2303,   0,      -2303,  -4533,  -6622,  -8507,  -10139, -11478, -12506, -13217, -13621, -13745, -13628,
         -13321, -12883, -12376, -11861, -11401, -11049, -10850, -10837, -11033, -11446, -12073, -12896, -13891, -15027,
         -16261, -17555, -18868, -20163, -21404, -22567, -23633, -24590, -25435, -26174, -26815, -27374, -27868, -28315,
         -28732, -29135, -29530, -29928, -30328, -30726, -31113, -31478, -31808, -32088, -32304, -32447, -32508, -32485,
         -32380, -32201, -31961, -31676, -31366, -31053, -30759, -30506, -30311, -30188, -30145, -30188, -30311, -30506,
         -30759, -31053, -31366, -31675, -31961, -32201, -32381, -32486, -32509, -32447, -32304, -32088, -31808, -31478,
         -31113, -30726, -30328, -29929, -29531, -29134, -28732, -28315, -27868, -27374, -26816, -26174, -25435, -24590,
         -23633, -22567, -21404, -20163, -18869, -17556, -16261, -15027, -13893, -12896, -12073, -11446, -11033, -10837,
         -10850, -11049, -11401, -11862, -12375, -12883, -13322, -13628, -13745, -13621, -13217, -12507, -11480, -10139,
         -8507,  -6623,  -4535,  -2303,  0};

  const int toneGenWave4[257]
      = {0,      2519,   4954,   7227,   9267,   11017,  12433,  13490,  14181,  14520,  14534,  14270,  13785,  13145,
         12424,  11694,  11025,  10483,  10122,  9982,   10092,  10466,  11100,  11979,  13074,  14349,  15756,  17247,
         18772,  20283,  21736,  23093,  24328,  25421,  26361,  27150,  27793,  28307,  28711,  29027,  29279,  29488,
         29676,  29856,  30043,  30242,  30452,  30674,  30899,  31119,  31323,  31500,  31642,  31741,  31794,  31803,
         31769,  31700,  31605,  31495,  31383,  31281,  31199,  31147,  31128,  31147,  31199,  31281,  31383,  31495,
         31604,  31700,  31769,  31803,  31794,  31741,  31642,  31500,  31323,  31119,  30900,  30674,  30452,  30242,
         30043,  29857,  29676,  29488,  29279,  29027,  28711,  28307,  27794,  27150,  26361,  25421,  24328,  23093,
         21736,  20284,  18772,  17247,  15756,  14349,  13074,  11979,  11100,  10466,  10092,  9982,   10122,  10483,
         11025,  11694,  12424,  13145,  13785,  14270,  14535,  14520,  14181,  13490,  12433,  11017,  9267,   7227,
         4954,   2519,   0,      -2518,  -4953,  -7227,  -9267,  -11017, -12432, -13489, -14181, -14520, -14534, -14270,
         -13785, -13145, -12424, -11693, -11025, -10483, -10122, -9982,  -10092, -10466, -11100, -11979, -13074, -14349,
         -15756, -17247, -18772, -20283, -21735, -23093, -24328, -25421, -26361, -27150, -27793, -28307, -28711, -29027,
         -29279, -29488, -29675, -29856, -30043, -30242, -30452, -30674, -30899, -31119, -31323, -31500, -31641, -31740,
         -31794, -31803, -31769, -31700, -31604, -31495, -31383, -31281, -31199, -31147, -31128, -31147, -31199, -31281,
         -31383, -31495, -31605, -31700, -31769, -31803, -31795, -31741, -31642, -31500, -31323, -31119, -30899, -30674,
         -30452, -30242, -30043, -29857, -29676, -29488, -29278, -29027, -28711, -28307, -27794, -27150, -26361, -25421,
         -24328, -23093, -21736, -20284, -18772, -17248, -15756, -14349, -13075, -11979, -11100, -10466, -10092, -9981,
         -10121, -10483, -11025, -11693, -12423, -13145, -13785, -14270, -14535, -14520, -14181, -13490, -12433, -11017,
         -9267,  -7227,  -4955,  -2519,  0};

  int16_t toneGenRAM[257];

  uint32_t phase_accumulator1;
  uint32_t phase_accumulator2;
  uint32_t phase_accumulator3;
  uint32_t phase_accumulator4;
  uint32_t phase_accumulator5;
  uint32_t phase_accumulator6;
  uint32_t phase_accumulator7;
  uint32_t phase_accumulator8;
  uint32_t phase_accumulator9;

  uint32_t phase_increment1;
  uint32_t phase_increment2;
  uint32_t phase_increment3;
  uint32_t phase_increment4;
  uint32_t phase_increment5;
  uint32_t phase_increment6;
  uint32_t phase_increment7;
  uint32_t phase_increment8;
  uint32_t phase_increment9;

  int32_t magnitude1;
  int32_t magnitude2;
  int32_t magnitude3;
  int32_t magnitude4;
  int32_t magnitude5;
  int32_t magnitude6;
  int32_t magnitude7;
  int32_t magnitude8;
  int32_t magnitude9;

  int     noteOn;
  uint8_t percussiveVoice;
};

#endif
